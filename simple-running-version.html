<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoLive</title>
    <style>
        :root {
            --floor-color: #f0e4d3;
            --wall-color: #c8bead;
            --accent-color: #7fb069;
            --text-color: #4a4a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e8f4e5;
            color: var(--text-color);
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        button {
            background-color: var(--accent-color);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #6a9e57;
        }

        .game-container {
            height: 400px;
            background-color: #c4e3c2;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .house {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            height: 100%;
        }

        .room {
            background-color: var(--floor-color);
            border: 2px solid var(--wall-color);
            position: relative;
        }

        .character {
            width: 40px;
            height: 40px;
            position: absolute;
            bottom: 20px;
            left: calc(50% - 20px);
            cursor: pointer;
        }

        .character-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .character[data-id="AB"] .character-inner { background-color: #FF6B6B; }
        .character[data-id="IR"] .character-inner { background-color: #4ECDC4; }
        .character[data-id="RP"] .character-inner { background-color: #FFD166; }
        .character[data-id="GR"] .character-inner { background-color: #70C1B3; }
        .character[data-id="CG"] .character-inner { background-color: #B8336A; }

        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 10px;
            padding: 10px;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent;
        }

        .speech-bubble.active {
            opacity: 1;
        }

        .notification-panel {
            margin-top: 20px;
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        #notifications-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            padding: 10px;
            background-color: #f8f8f8;
            border-left: 4px solid var(--accent-color);
            border-radius: 4px;
        }

        .context-menu {
            display: none;
            position: absolute;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .context-menu ul {
            list-style: none;
        }

        .context-menu li {
            padding: 10px 15px;
            cursor: pointer;
        }

        .context-menu li:hover {
            background-color: #f0f0f0;
        }

        .sleeping .character-inner:after {
            content: "ğŸ’¤";
            position: absolute;
            top: -15px;
            right: -10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DuoLive</h1>
            <div class="controls">
                <button id="language-btn">English</button>
                <button id="import-btn">å¯¼å…¥æ—¥ç¨‹</button>
                <button id="demo-btn">åŠ è½½ç¤ºä¾‹</button>
                <span id="time-display"></span>
            </div>
        </header>
        
        <div class="game-container">
            <div class="house" id="house">
                <!-- æˆ¿é—´å°†ç”±JavaScriptç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="notification-panel">
            <h3 id="notifications-title">é€šçŸ¥</h3>
            <div id="notifications-list"></div>
        </div>
        
        <input type="file" id="file-upload" accept=".ics" style="display: none;">
    </div>

    <div id="character-menu" class="context-menu">
        <ul>
            <li data-action="status" id="menu-status">æŸ¥çœ‹çŠ¶æ€</li>
            <li data-action="remind" id="menu-remind">å‘é€æé†’</li>
            <li data-action="poke" id="menu-poke">æˆ³ä¸€æˆ³</li>
            <li data-action="chat" id="menu-chat">èŠå¤©</li>
        </ul>
    </div>

    <script>
        // ç¿»è¯‘æ•°æ®
        const translations = {
            'zh-CN': {
                'import': 'å¯¼å…¥æ—¥ç¨‹',
                'demo': 'åŠ è½½ç¤ºä¾‹',
                'notifications': 'é€šçŸ¥',
                'status': 'æŸ¥çœ‹çŠ¶æ€',
                'remind': 'å‘é€æé†’',
                'poke': 'æˆ³ä¸€æˆ³',
                'chat': 'èŠå¤©',
                'import_success': 'æˆåŠŸå¯¼å…¥ {0} ä¸ªæ—¥ç¨‹äº‹ä»¶',
                'import_fail': 'å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼',
                'reminded': 'ä½ æé†’äº† {0} å…³äºä»–ä»¬çš„æ—¥ç¨‹',
                'dont_poke': 'å˜¿ï¼åˆ«æˆ³æˆ‘ï¼',
                'status_msg': 'æˆ‘çš„çŠ¶æ€æ˜¯ï¼š{0}',
                'will_remember': 'è°¢è°¢æé†’ï¼Œæˆ‘ä¼šè®°å¾—æˆ‘çš„æ—¥ç¨‹ï¼',
                'event_notice': '{0} çš„äº‹ä»¶ï¼š{1}ï¼Œå°†åœ¨ {2} å¼€å§‹',
                'my_event': 'æˆ‘çš„äº‹ä»¶ "{0}" å³å°†å¼€å§‹ï¼',
                'notifications_on': 'é€šçŸ¥æƒé™å·²å¯ç”¨',
                'demo_loaded': 'ç¤ºä¾‹æ—¥ç¨‹å·²åŠ è½½',
                'idle': 'ç©ºé—²',
                'sleeping': 'ç¡è§‰ä¸­',
                'working': 'å·¥ä½œä¸­',
                'meeting': 'å¼€ä¼šä¸­'
            },
            'en-US': {
                'import': 'Import Calendar',
                'demo': 'Load Demo',
                'notifications': 'Notifications',
                'status': 'Check Status',
                'remind': 'Send Reminder',
                'poke': 'Poke',
                'chat': 'Chat',
                'import_success': 'Successfully imported {0} events',
                'import_fail': 'Import failed, check file format',
                'reminded': 'You reminded {0} about their schedule',
                'dont_poke': "Hey! Don't poke me!",
                'status_msg': 'My status is: {0}',
                'will_remember': "Thanks for the reminder!",
                'event_notice': "{0}'s event: {1}, starts at {2}",
                'my_event': 'My event "{0}" is about to start!',
                'notifications_on': 'Notifications enabled',
                'demo_loaded': 'Demo schedule loaded',
                'idle': 'idle',
                'sleeping': 'sleeping',
                'working': 'working',
                'meeting': 'in a meeting'
            }
        };

        // AIå›å¤
        const aiResponses = {
            'zh-CN': [
                "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ",
                "æˆ‘æ­£åœ¨æ€è€ƒäººç”Ÿçš„æ„ä¹‰...",
                "ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œå¯¹å§ï¼Ÿ",
                "ä½ çŸ¥é“å—ï¼Ÿæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ï¼"
            ],
            'en-US': [
                "Hello! How can I help you?",
                "I'm thinking about the meaning of life...",
                "Nice weather today, isn't it?",
                "Did you know? My favorite color is blue!"
            ]
        };

        // æ ¼å¼åŒ–å­—ç¬¦ä¸²
        function format(str, ...args) {
            return str.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined' ? args[number] : match;
            });
        }

        // DuoLiveåº”ç”¨
        class DuoLive {
            constructor() {
                this.characters = {
                    'AB': { status: 'idle', room: 0 },
                    'RP': { status: 'idle', room: 1 },
                    'IR': { status: 'idle', room: 2 },
                    'GR': { status: 'idle', room: 3 },
                    'CG': { status: 'idle', room: 4 }
                };
                this.events = [];
                this.selectedCharacter = null;
                this.language = 'zh-CN';

                this.createRooms();
                this.createCharacters();
                this.setupClock();
                this.setupEvents();
                this.requestNotifications();
            }

            // åˆ›å»ºæˆ¿é—´
            createRooms() {
                const house = document.getElementById('house');
                for (let i = 0; i < 5; i++) {
                    const room = document.createElement('div');
                    room.className = 'room';
                    room.dataset.roomId = i;
                    house.appendChild(room);
                }
            }

            // åˆ›å»ºè§’è‰²
            createCharacters() {
                for (const [id, data] of Object.entries(this.characters)) {
                    const room = document.querySelector(`.room[data-room-id="${data.room}"]`);
                    
                    const character = document.createElement('div');
                    character.className = 'character';
                    character.dataset.id = id;
                    
                    const inner = document.createElement('div');
                    inner.className = 'character-inner';
                    inner.textContent = id;
                    character.appendChild(inner);
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'speech-bubble';
                    character.appendChild(bubble);
                    
                    room.appendChild(character);
                    
                    character.addEventListener('click', (e) => {
                        this.openCharacterMenu(e, id);
                    });
                }
            }

            // æ—¶é’Ÿå’ŒçŠ¶æ€æ›´æ–°
            setupClock() {
                const timeDisplay = document.getElementById('time-display');
                
                const updateTime = () => {
                    const now = new Date();
                    timeDisplay.textContent = now.toLocaleTimeString();
                    this.updateStates(now);
                    this.checkEvents(now);
                };
                
                updateTime();
                setInterval(updateTime, 1000);
            }

            // æ›´æ–°è§’è‰²çŠ¶æ€
            updateStates(now) {
                const hour = now.getHours();
                
                for (const [id, data] of Object.entries(this.characters)) {
                    const character = document.querySelector(`.character[data-id="${id}"]`);
                    if (hour >= 22 || hour < 6) {
                        character.classList.add('sleeping');
                        this.characters[id].status = 'sleeping';
                    } else {
                        character.classList.remove('sleeping');
                        if (this.characters[id].status === 'sleeping') {
                            this.characters[id].status = 'idle';
                        }
                    }
                }
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEvents() {
                // è¯­è¨€åˆ‡æ¢
                document.getElementById('language-btn').addEventListener('click', () => {
                    this.toggleLanguage();
                });
                
                // å¯¼å…¥æŒ‰é’®
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('file-upload').click();
                });
                
                // æ–‡ä»¶ä¸Šä¼ 
                document.getElementById('file-upload').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileUpload(e.target.files[0]);
                    }
                });
                
                // ç¤ºä¾‹æŒ‰é’®
                document.getElementById('demo-btn').addEventListener('click', () => {
                    this.loadDemoEvents();
                });
                
                // ç‚¹å‡»èœå•é¡¹
                document.querySelectorAll('#character-menu li').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        if (this.selectedCharacter) {
                            this.handleAction(action, this.selectedCharacter);
                        }
                        this.closeMenu();
                    });
                });
                
                // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.character') && !e.target.closest('#character-menu')) {
                        this.closeMenu();
                    }
                });
            }

            // åˆ‡æ¢è¯­è¨€
            toggleLanguage() {
                this.language = this.language === 'zh-CN' ? 'en-US' : 'zh-CN';
                document.getElementById('language-btn').textContent = this.language === 'zh-CN' ? 'English' : 'ä¸­æ–‡';
                this.updateTexts();
            }

            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            updateTexts() {
                document.getElementById('import-btn').textContent = translations[this.language]['import'];
                document.getElementById('demo-btn').textContent = translations[this.language]['demo'];
                document.getElementById('notifications-title').textContent = translations[this.language]['notifications'];
                document.getElementById('menu-status').textContent = translations[this.language]['status'];
                document.getElementById('menu-remind').textContent = translations[this.language]['remind'];
                document.getElementById('menu-poke').textContent = translations[this.language]['poke'];
                document.getElementById('menu-chat').textContent = translations[this.language]['chat'];
            }

            // æ‰“å¼€è§’è‰²èœå•
            openCharacterMenu(event, characterId) {
                event.stopPropagation();
                this.selectedCharacter = characterId;
                
                const menu = document.getElementById('character-menu');
                menu.style.display = 'block';
                menu.style.left = `${event.pageX}px`;
                menu.style.top = `${event.pageY}px`;
            }

            // å…³é—­èœå•
            closeMenu() {
                document.getElementById('character-menu').style.display = 'none';
                this.selectedCharacter = null;
            }

            // å¤„ç†èœå•åŠ¨ä½œ
            handleAction(action, characterId) {
                switch (action) {
                    case 'status':
                        this.showStatus(characterId);
                        break;
                    case 'remind':
                        this.sendReminder(characterId);
                        break;
                    case 'poke':
                        this.pokeCharacter(characterId);
                        break;
                    case 'chat':
                        this.chatWithAI(characterId);
                        break;
                }
            }

            // æ˜¾ç¤ºè§’è‰²çŠ¶æ€
            showStatus(characterId) {
                const status = this.characters[characterId].status;
                const statusText = translations[this.language][status];
                const message = format(translations[this.language]['status_msg'], statusText);
                this.showBubble(characterId, message);
            }

            // å‘é€æé†’
            sendReminder(characterId) {
                this.showBubble(characterId, translations[this.language]['will_remember']);
                this.addNotification(format(translations[this.language]['reminded'], characterId));
            }

            // æˆ³è§’è‰²
            pokeCharacter(characterId) {
                const character = document.querySelector(`.character[data-id="${characterId}"]`);
                
                character.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    character.style.transform = 'translateY(0)';
                }, 200);
                
                this.showBubble(characterId, translations[this.language]['dont_poke']);
            }

            // AIèŠå¤©
            chatWithAI(characterId) {
                const responses = aiResponses[this.language];
                const message = responses[Math.floor(Math.random() * responses.length)];
                this.showBubble(characterId, message);
            }

            // æ˜¾ç¤ºå¯¹è¯æ°”æ³¡
            showBubble(characterId, text) {
                const character = document.querySelector(`.character[data-id="${characterId}"]`);
                const bubble = character.querySelector('.speech-bubble');
                
                bubble.textContent = text;
                bubble.classList.add('active');
                
                setTimeout(() => {
                    bubble.classList.remove('active');
                }, 5000);
            }

            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            handleFileUpload(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const events = this.parseICS(e.target.result);
                        this.events = this.events.concat(events);
                        this.addNotification(format(translations[this.language]['import_success'], events.length));
                    } catch (error) {
                        this.addNotification(translations[this.language]['import_fail'], true);
                    }
                };
                reader.readAsText(file);
            }

            // ç®€å•ICSè§£æ
            parseICS(icsData) {
                const events = [];
                const lines = icsData.split('\n');
                let currentEvent = null;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    
                    if (trimmedLine === 'BEGIN:VEVENT') {
                        currentEvent = { userId: '', startTime: null, description: '' };
                    } 
                    else if (trimmedLine.startsWith('SUMMARY:') && currentEvent) {
                        currentEvent.description = trimmedLine.substring(8);
                    }
                    else if (trimmedLine.startsWith('DTSTART:') && currentEvent) {
                        const dateStr = trimmedLine.substring(8);
                        try {
                            // å¤„ç†å¸¸è§çš„æ—¥æœŸæ ¼å¼ yyyyMMddTHHmmssZ
                            const year = parseInt(dateStr.substring(0, 4));
                            const month = parseInt(dateStr.substring(4, 6)) - 1;
                            const day = parseInt(dateStr.substring(6, 8));
                            const hour = parseInt(dateStr.substring(9, 11));
                            const minute = parseInt(dateStr.substring(11, 13));
                            currentEvent.startTime = new Date(year, month, day, hour, minute);
                        } catch (e) {
                            console.error('æ—¥æœŸè§£æé”™è¯¯', e);
                        }
                    }
                    else if (trimmedLine.startsWith('DESCRIPTION:') && currentEvent) {
                        const desc = trimmedLine.substring(12);
                        if (desc.startsWith('UserID:')) {
                            currentEvent.userId = desc.substring(7);
                        }
                    }
                    else if (trimmedLine === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.startTime && currentEvent.userId) {
                            events.push(currentEvent);
                        }
                        currentEvent = null;
                    }
                }
                
                return events;
            }

            // æ£€æŸ¥äº‹ä»¶
            checkEvents(now) {
                for (const event of this.events) {
                    if (!event.notified) {
                        const timeDiff = (event.startTime.getTime() - now.getTime()) / (1000 * 60);
                        
                        if (timeDiff > 0 && timeDiff <= 5) {
                            this.notifyEvent(event);
                            event.notified = true;
                        }
                    }
                }
            }

            // é€šçŸ¥äº‹ä»¶
            notifyEvent(event) {
                const timeString = event.startTime.toLocaleTimeString();
                this.addNotification(format(
                    translations[this.language]['event_notice'],
                    event.userId,
                    event.description,
                    timeString
                ));
                
                this.showBubble(event.userId, format(
                    translations[this.language]['my_event'],
                    event.description
                ));
                
                // æµè§ˆå™¨é€šçŸ¥
                if (this.notificationsEnabled) {
                    new Notification(`DuoLive - ${event.userId}`, {
                        body: `${event.description} - ${timeString}`
                    });
                }
            }

            // æ·»åŠ é€šçŸ¥
            addNotification(message, isError = false) {
                const list = document.getElementById('notifications-list');
                
                const notification = document.createElement('div');
                notification.className = `notification-item${isError ? ' error' : ''}`;
                notification.textContent = message;
                
                list.insertBefore(notification, list.firstChild);
                
                // æœ€å¤šä¿ç•™10æ¡
                while (list.children.length > 10) {
                    list.removeChild(list.lastChild);
                }
            }

            // è¯·æ±‚é€šçŸ¥æƒé™
            requestNotifications() {
                this.notificationsEnabled = false;
                
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            this.notificationsEnabled = true;
                            this.addNotification(translations[this.language]['notifications_on']);
                        }
                    });
                }
            }

            // åŠ è½½ç¤ºä¾‹äº‹ä»¶
            loadDemoEvents() {
                const now = new Date();
                
                // åˆ›å»ºå››ä¸ªäº‹ä»¶ï¼Œåˆ†åˆ«åœ¨1-4åˆ†é’Ÿå
                const demoEvents = [
                    {
                        userId: 'AB',
                        description: this.language === 'zh-CN' ? 'äº§å“å›¢é˜Ÿä¼šè®®' : 'Product Team Meeting',
                        startTime: new Date(now.getTime() + 1 * 60 * 1000),
                        notified: false
                    },
                    {
                        userId: 'RP',
                        description: this.language === 'zh-CN' ? 'æäº¤é¡¹ç›®æŠ¥å‘Š' : 'Submit Project Report',
                        startTime: new Date(now.getTime() + 2 * 60 * 1000),
                        notified: false
                    },
                    {
                        userId: 'IR',
                        description: this.language === 'zh-CN' ? 'åˆé¤æ—¶é—´' : 'Lunch Break',
                        startTime: new Date(now.getTime() + 3 * 60 * 1000),
                        notified: false
                    },
                    {
                        userId: 'GR',
                        description: this.language === 'zh-CN' ? 'å®¢æˆ·å›ç”µ' : 'Call Client',
                        startTime: new Date(now.getTime() + 4 * 60 * 1000),
                        notified: false
                    }
                ];
                
                this.events = this.events.concat(demoEvents);
                
                // æ›´æ–°è§’è‰²çŠ¶æ€
                this.characters['AB'].status = 'meeting';
                this.characters['RP'].status = 'working';
                
                this.addNotification(translations[this.language]['demo_loaded']);
            }
        }

        // å½“æ–‡æ¡£åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new DuoLive();
        });
    </script>
</body>
</html>
